<%- include('layout') %>
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-11">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-header bg-primary text-white d-flex align-items-center">
          <h4 class="mb-0"><i class="bi bi-bar-chart me-2"></i> <%= t.salesReport %></h4>
        </div>
        <div class="card-body p-4">
          <form class="row g-2 mb-4 align-items-end" method="get" action="">
            <div class="col-md-3">
              <input type="text" name="customerName" class="form-control rounded-pill" placeholder="<%= t.customerName %>" value="<%= filter?.customerName || '' %>">
            </div>
            <div class="col-md-2">
              <input type="date" name="from" class="form-control rounded-pill" value="<%= filter?.from || '' %>">
            </div>
            <div class="col-md-2">
              <input type="date" name="to" class="form-control rounded-pill" value="<%= filter?.to || '' %>">
            </div>
            <div class="col-md-2">
              <select name="itemType" class="form-select rounded-pill">
                <option value="all" <%= filter?.itemType === 'all' ? 'selected' : '' %>><%= t.all %></option>
                <option value="product" <%= filter?.itemType === 'product' ? 'selected' : '' %>><%= t.product %></option>
                <option value="service" <%= filter?.itemType === 'service' ? 'selected' : '' %>><%= t.service %></option>
              </select>
            </div>
            <div class="col-md-1">
              <button class="btn btn-primary w-100 rounded-pill" type="submit"><i class="bi bi-search"></i> <%= t.search %></button>
            </div>
            <div class="col-md-2 d-flex gap-2">
              <button type="button" class="btn btn-outline-danger w-100 rounded-pill" onclick="exportTableToPDF('sales-table', '<%= t.salesReport %>')"><i class="bi bi-file-earmark-pdf"></i> <%= t.exportPDF %></button>
              <button type="button" class="btn btn-outline-success w-100 rounded-pill" onclick="exportTableToExcel('sales-table', '<%= t.salesReport %>')"><i class="bi bi-file-earmark-excel"></i> <%= t.exportExcel %></button>
            </div>
          </form>
          <div class="row g-3 mb-4">
            <div class="col-6 col-md-3">
              <div class="card text-center bg-light border-0 shadow-sm">
                <div class="card-body">
                  <div class="fw-bold fs-5"><i class="bi bi-calendar-day text-success"></i> اليوم</div>
                  <div class="fs-4 text-success"><%= totalToday %> جنيه</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center bg-light border-0 shadow-sm">
                <div class="card-body">
                  <div class="fw-bold fs-5"><i class="bi bi-calendar-week text-primary"></i> الأسبوع</div>
                  <div class="fs-4 text-primary"><%= totalWeek %> جنيه</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center bg-light border-0 shadow-sm">
                <div class="card-body">
                  <div class="fw-bold fs-5"><i class="bi bi-calendar-month text-warning"></i> الشهر</div>
                  <div class="fs-4 text-warning"><%= totalMonth %> جنيه</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="card text-center bg-light border-0 shadow-sm">
                <div class="card-body">
                  <div class="fw-bold fs-5"><i class="bi bi-cash-coin text-danger"></i> الإجمالي الكلي</div>
                  <div class="fs-4 text-danger"><%= totalAll %> جنيه</div>
                </div>
              </div>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle text-center" id="sales-table">
              <thead class="table-light">
                <tr>
                  <th><%= t.date %></th>
                  <th><%= t.customerName %></th>
                  <th><%= t.itemType %></th>
                  <th><%= t.totalAll %></th>
                </tr>
              </thead>
              <tbody>
                <% if (sales.length === 0) { %>
                  <tr><td colspan="4" class="text-center"><%= t.noResults %></td></tr>
                <% } %>
                <% sales.forEach(sale => { %>
                  <tr>
                    <td><%= sale.createdAt ? sale.createdAt.toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US') : '-' %></td>
                    <td><%= sale.customerName || '-' %></td>
                    <td>
                      <ul class="mb-0 ps-3">
                        <% sale.items.forEach(item => { %>
                          <li><%= t[item.type] %> - <%= item.name %> (<%= item.price %> × <%= item.quantity %>)</li>
                        <% }) %>
                      </ul>
                    </td>
                    <td><%= sale.totalPrice %> جنيه</td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
          <a href="/dashboard" class="btn btn-secondary mt-3 rounded-pill px-4"><i class="bi bi-arrow-right-circle"></i> <%= t.back %></a>
        </div>
      </div>
    </div>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="/js/jspdf.umd.min.js"></script>
<script src="/js/jspdf.plugin.autotable.min.js"></script>
<script src="/js/xlsx.full.min.js"></script>
<script src="/js/export.js"></script>
