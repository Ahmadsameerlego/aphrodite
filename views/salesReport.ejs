<%- include('layout') %>
<h2 class="mb-4 text-center"><%= t.salesReport %></h2>

<form class="row g-2 mb-4" method="get" action="">
  <div class="col-md-3">
    <input type="text" name="customerName" class="form-control" placeholder="<%= t.customerName %>" value="<%= filter?.customerName || '' %>">
  </div>
  <div class="col-md-2">
    <input type="date" name="from" class="form-control" value="<%= filter?.from || '' %>">
  </div>
  <div class="col-md-2">
    <input type="date" name="to" class="form-control" value="<%= filter?.to || '' %>">
  </div>
  <div class="col-md-2">
    <select name="itemType" class="form-select">
      <option value="all" <%= filter?.itemType === 'all' ? 'selected' : '' %>><%= t.all %></option>
      <option value="product" <%= filter?.itemType === 'product' ? 'selected' : '' %>><%= t.product %></option>
      <option value="service" <%= filter?.itemType === 'service' ? 'selected' : '' %>><%= t.service %></option>
    </select>
  </div>
  <div class="col-md-1">
    <button class="btn btn-primary w-100" type="submit"><%= t.search %></button>
  </div>
  <div class="col-md-2 d-flex gap-2">
    <button type="button" class="btn btn-outline-danger w-100" onclick="exportTableToPDF('sales-table', '<%= t.salesReport %>')"><%= t.exportPDF %></button>
    <button type="button" class="btn btn-outline-success w-100" onclick="exportTableToExcel('sales-table', '<%= t.salesReport %>')"><%= t.exportExcel %></button>
  </div>
</form>
  <div class="col-6 col-md-3">
    <div class="card text-center bg-light">
      <div class="card-body">
        <div class="fw-bold fs-5">اليوم</div>
        <div class="fs-4 text-success"><%= totalToday %> جنيه</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center bg-light">
      <div class="card-body">
        <div class="fw-bold fs-5">الأسبوع</div>
        <div class="fs-4 text-primary"><%= totalWeek %> جنيه</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center bg-light">
      <div class="card-body">
        <div class="fw-bold fs-5">الشهر</div>
        <div class="fs-4 text-warning"><%= totalMonth %> جنيه</div>
      </div>
    </div>
  </div>
  <div class="col-6 col-md-3">
    <div class="card text-center bg-light">
      <div class="card-body">
        <div class="fw-bold fs-5">الإجمالي الكلي</div>
        <div class="fs-4 text-danger"><%= totalAll %> جنيه</div>
      </div>
    </div>
  </div>
</div>
<div class="table-responsive">
  <table class="table table-bordered table-striped" id="sales-table">
    <thead class="table-light">
      <tr>
        <th><%= t.date %></th>
        <th><%= t.customerName %></th>
        <th><%= t.itemType %></th>
        <th><%= t.totalAll %></th>
      </tr>
    </thead>
    <tbody>
      <% if (sales.length === 0) { %>
        <tr><td colspan="4" class="text-center"><%= t.noResults %></td></tr>
      <% } %>
      <% sales.forEach(sale => { %>
        <tr>
          <td><%= sale.createdAt ? sale.createdAt.toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US') : '-' %></td>
          <td><%= sale.customerName || '-' %></td>
          <td>
            <ul class="mb-0 ps-3">
              <% sale.items.forEach(item => { %>
                <li><%= t[item.type] %> - <%= item.name %> (<%= item.price %> × <%= item.quantity %>)</li>
              <% }) %>
            </ul>
          </td>
          <td><%= sale.totalPrice %> جنيه</td>
        </tr>
      <% }) %>
    </tbody>
  </table>
</div>
<a href="/dashboard" class="btn btn-secondary mt-3"><%= t.back %></a>
<script src="/js/jspdf.umd.min.js"></script>
<script src="/js/jspdf.plugin.autotable.min.js"></script>
<script src="/js/xlsx.full.min.js"></script>
<script src="/js/export.js"></script>
